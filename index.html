<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Prout-Piano (Real Audio) ðŸ’¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka+One&display=swap');

        body {
            font-family: 'Fredoka One', cursive;
            background: radial-gradient(circle at center, #fdfbf7 0%, #eaddcf 100%);
            touch-action: manipulation;
            overflow: hidden;
        }

        .piano-container {
            perspective: 1000px;
        }

        .key {
            transition: all 0.1s ease;
            position: relative;
            cursor: pointer;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .white-key {
            background: linear-gradient(to bottom, #fff 0%, #eee 100%);
            box-shadow: 0 4px 5px rgba(0,0,0,0.2), inset 0 0 5px rgba(255,255,255,0.5);
            z-index: 1;
            border-radius: 0 0 5px 5px;
            height: 12rem;
        }

        .white-key:active, .white-key.active {
            transform: rotateX(-5deg) translateY(2px);
            background: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
            box-shadow: 0 2px 3px rgba(0,0,0,0.2);
        }

        .black-key {
            background: linear-gradient(to bottom, #444 0%, #222 100%);
            box-shadow: 2px 2px 4px rgba(0,0,0,0.4);
            z-index: 2;
            height: 7rem;
            width: 3rem;
            margin-left: -1.5rem;
            margin-right: -1.5rem;
            border-radius: 0 0 3px 3px;
        }

        .black-key:active, .black-key.active {
            transform: rotateX(-5deg) translateY(2px);
            background: #111;
        }

        .fart-cloud {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            animation: floatUp 1s ease-out forwards;
            opacity: 0;
            z-index: 50;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 0.8; }
            100% { transform: translateY(-100px) scale(1.5) rotate(20deg); opacity: 0; }
        }

        .emoji-title {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        /* Loading Overlay */
        #loader {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-center;
            z-index: 100;
            transition: opacity 0.5s;
        }
        .hidden-loader {
            opacity: 0;
            pointer-events: none;
        }
        .progress-bar {
            width: 200px;
            height: 10px;
            background: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
        }
        .progress-fill {
            height: 100%;
            background: #d97706; /* amber-600 */
            width: 0%;
            transition: width 0.3s;
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center text-amber-900">

    <!-- Loader -->
    <div id="loader">
        <div class="text-6xl mb-4 animate-bounce">ðŸ’¨</div>
        <h2 class="text-2xl font-bold text-amber-800">Chargement des gaz...</h2>
        <p class="text-sm text-gray-500 mt-2">RÃ©cupÃ©ration depuis GitHub</p>
        <div class="progress-bar">
            <div id="progress" class="progress-fill"></div>
        </div>
        <p id="loading-text" class="text-xs mt-2 text-gray-400">0%</p>
    </div>

    <!-- Header -->
    <div class="text-center mb-6 px-4">
        <h1 class="text-4xl md:text-6xl mb-2 flex items-center justify-center gap-3">
            <span class="emoji-title">ðŸ’¨</span> Le Prout-Piano <span class="emoji-title" style="animation-delay: 0.2s">ðŸ’©</span>
        </h1>
        <p class="text-lg opacity-80 mb-4">Ã‰chantillons rÃ©els (GitHub Edition)</p>
        
        <div class="flex gap-4 justify-center text-sm">
            <div class="bg-amber-100 px-3 py-1 rounded-full border border-amber-200">
                Source: <strong>RÃ©el</strong>
            </div>
            <div class="bg-green-100 px-3 py-1 rounded-full border border-green-200 text-green-800">
                Mode: <strong>Sampler</strong>
            </div>
        </div>
    </div>

    <!-- Piano -->
    <div class="piano-container bg-amber-900 p-4 rounded-xl shadow-2xl border-t-4 border-amber-700 max-w-full overflow-x-auto">
        <div class="flex justify-center relative" id="keyboard">
            <!-- Keys generated by JS -->
        </div>
    </div>

    <div class="mt-8 text-sm text-gray-500 text-center">
        Utilisez votre souris, votre doigt ou le clavier (A-K).<br>
        <span class="text-xs opacity-75">Sons gracieusement hÃ©bergÃ©s par GitHub (repo: js-fart-soundboard)</span>
    </div>

    <script>
        // --- Audio Context & Loading ---
        let audioCtx;
        const soundBuffers = {};
        // URLs from a public github repo
        const baseUrl = "https://raw.githubusercontent.com/cltw29/js-fart-soundboard/master/";
        const soundFiles = [
            "fart-01.wav",
            "fart-02.wav",
            "fart-03.wav",
            "fart-04.wav",
            "fart-05.wav",
            "fart-06.wav",
            "fart-07.wav",
            "fart-08.wav"
        ];

        async function initAudio() {
            if (!audioCtx) {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioCtx.state === 'suspended') {
                await audioCtx.resume();
            }
        }

        async function loadSounds() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            
            let loaded = 0;
            const progressEl = document.getElementById('progress');
            const textEl = document.getElementById('loading-text');

            for (let i = 0; i < soundFiles.length; i++) {
                const filename = soundFiles[i];
                try {
                    const response = await fetch(baseUrl + filename);
                    const arrayBuffer = await response.arrayBuffer();
                    const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);
                    soundBuffers[filename] = audioBuffer;
                } catch (e) {
                    console.error("Erreur chargement " + filename, e);
                }
                
                loaded++;
                const percentage = Math.round((loaded / soundFiles.length) * 100);
                progressEl.style.width = percentage + "%";
                textEl.innerText = percentage + "%";
            }

            // Hide loader
            setTimeout(() => {
                document.getElementById('loader').classList.add('hidden-loader');
            }, 500);
        }

        // --- Playback Logic ---
        function playSample(filename, detuneCents = 0, playbackRate = 1.0) {
            if (!audioCtx || !soundBuffers[filename]) return;

            const source = audioCtx.createBufferSource();
            source.buffer = soundBuffers[filename];
            
            // Randomize slightly for realism
            const randomDetune = (Math.random() * 50) - 25; 
            source.detune.value = detuneCents + randomDetune;
            source.playbackRate.value = playbackRate;

            const gainNode = audioCtx.createGain();
            // A bit of compression/limiting
            gainNode.gain.value = 0.8;

            source.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            source.start(0);
        }

        // --- Keyboard Setup ---
        
        // Mapping: We have 8 files, 13 keys. We'll reuse some files but pitch shift them.
        // Base freq C4 is roughly mapped to rate 1.0
        const notes = [
            { note: "C",  type: "white", key: "a", file: "fart-01.wav", rate: 0.8 }, // Low
            { note: "C#", type: "black", key: "w", file: "fart-01.wav", rate: 0.9 },
            { note: "D",  type: "white", key: "s", file: "fart-02.wav", rate: 0.9 }, // Wet
            { note: "D#", type: "black", key: "e", file: "fart-02.wav", rate: 1.0 },
            { note: "E",  type: "white", key: "d", file: "fart-03.wav", rate: 1.0 }, // Dry
            { note: "F",  type: "white", key: "f", file: "fart-04.wav", rate: 1.0 }, // Long
            { note: "F#", type: "black", key: "t", file: "fart-04.wav", rate: 1.1 },
            { note: "G",  type: "white", key: "g", file: "fart-05.wav", rate: 1.0 }, // Squeaky start
            { note: "G#", type: "black", key: "y", file: "fart-06.wav", rate: 1.0 },
            { note: "A",  type: "white", key: "h", file: "fart-07.wav", rate: 1.0 },
            { note: "A#", type: "black", key: "u", file: "fart-07.wav", rate: 1.1 },
            { note: "B",  type: "white", key: "j", file: "fart-08.wav", rate: 1.0 }, // Short/High
            { note: "C2", type: "white", key: "k", file: "fart-08.wav", rate: 1.2 }, // Very high
        ];

        const keyboardEl = document.getElementById('keyboard');
        const visualEmojis = ["ðŸ’¨", "ðŸ¤¢", "ðŸ˜¶â€ðŸŒ«ï¸", "ðŸ¥´", "ðŸ˜·", "ðŸ’©", "ðŸ§¨"];

        notes.forEach(note => {
            const keyEl = document.createElement('div');
            
            let classes = "key flex-shrink-0 flex items-end justify-center pb-2 font-bold text-gray-400 select-none";
            if (note.type === 'white') {
                classes += " white-key w-12 md:w-16 text-xl";
            } else {
                classes += " black-key text-xs z-10";
            }
            keyEl.className = classes;
            keyEl.dataset.key = note.key;
            
            if (note.type === 'white') {
                keyEl.innerHTML = `<span>${note.note}</span>`;
            }

            const triggerNote = async (e) => {
                if(e.type === 'touchstart') e.preventDefault();
                
                await initAudio(); // Ensure context is running

                keyEl.classList.add('active');
                setTimeout(() => keyEl.classList.remove('active'), 150);

                playSample(note.file, 0, note.rate);
                createCloud(keyEl);
            };

            keyEl.addEventListener('mousedown', triggerNote);
            keyEl.addEventListener('touchstart', triggerNote, {passive: false});

            keyboardEl.appendChild(keyEl);
        });

        function createCloud(element) {
            const cloud = document.createElement('div');
            cloud.className = 'fart-cloud';
            cloud.innerText = visualEmojis[Math.floor(Math.random() * visualEmojis.length)];
            
            const rect = element.getBoundingClientRect();
            cloud.style.left = (rect.left + rect.width / 2 - 15) + 'px';
            cloud.style.top = (rect.top - 30) + 'px';

            document.body.appendChild(cloud);

            setTimeout(() => {
                cloud.remove();
            }, 1000);
        }

        window.addEventListener('keydown', (e) => {
            if (e.repeat) return;
            const key = e.key.toLowerCase();
            const noteObj = notes.find(n => n.key === key);
            if (noteObj) {
                const domEl = document.querySelector(`div[data-key="${key}"]`);
                if(domEl) {
                    initAudio();
                    domEl.classList.add('active');
                    playSample(noteObj.file, 0, noteObj.rate);
                    createCloud(domEl);
                }
            }
        });

        window.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            const domEl = document.querySelector(`div[data-key="${key}"]`);
            if(domEl) domEl.classList.remove('active');
        });

        // Start loading immediately
        window.addEventListener('load', loadSounds);

    </script>
</body>
</html>
